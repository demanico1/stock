<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë””ë§ˆë‹ˆì½” ë‰´ìŠ¤ íŠ¸ë˜ì»¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Arial', sans-serif; background: #f4f6f9; margin: 0; padding: 16px; }
    h1 { text-align: center; color: #222; }
    .sheet-nav { position: sticky; top: 0; background: #fff; padding: 10px 0; border-bottom: 1px solid #ddd; z-index: 999; overflow-x: auto; white-space: nowrap; }
    .sheet-nav button { margin: 0 6px; padding: 8px 12px; border-radius: 16px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; font-size: 0.95em; display: inline-block; }
    .sheet-nav button.active { background: #007bff; color: white; border-color: #007bff; }
    .sheet-title { font-size: 1.2em; font-weight: bold; margin: 20px 0 10px; color: #007bff; }
    .hot-filter { margin: 12px 0; text-align: center; white-space: nowrap; overflow-x: auto; }
    .hot-filter button { margin: 0 6px; padding: 6px 12px; border-radius: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease; }
    .hot-filter button.active { background: #007bff; color: #fff; border-color: #007bff; }
    .search-box { text-align: center; margin-bottom: 16px; }
    .search-box input { padding: 8px 12px; font-size: 1em; width: 70%; max-width: 300px; border-radius: 8px; border: 1px solid #ccc; }
    .search-box button { padding: 8px 14px; margin-left: 6px; font-size: 1em; border-radius: 8px; background: #007bff; color: white; border: none; cursor: pointer; }
    .news-card { background: #fff; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: opacity 0.3s ease; }
    .news-card.hide { display: none; }
    .highlight-both { background: #ffe5e5; border: 2px solid #cc0000; }
    .highlight-news { background: #fff7e6; }
    .highlight-channel { background: #ffe6cc; }
    .highlight { background-color: #fff176; font-weight: bold; padding: 0 2px; border-radius: 4px; }
    .accordion { font-size: 1.1em; font-weight: bold; cursor: pointer; padding: 16px; width: 100%; border: none; text-align: left; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 10px; transition: background 0.3s; color: #111 !important; }
    .accordion:hover, .accordion.active { background-color: #e4f0ff; }
    .panel { padding: 0 16px; background: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-left: 3px solid #007bff; border-radius: 0 0 8px 8px; }
    .news-title { font-weight: bold; font-size: 1.1em; color: #111 !important; }
    .news-time { font-size: 0.9em; color: #666; margin-top: 6px; }
    .news-link a { font-size: 0.9em; color: #007bff; text-decoration: none; }
    .loading { color: #888; font-size: 0.95em; padding: 12px; text-align: center; }
    .fade-container { opacity: 1; transition: opacity 0.3s ease; }
    .fade-container.fade-out { opacity: 0; }
  </style>
</head>
<body>
  <h1>ë””ë§ˆë‹ˆì½” ë‰´ìŠ¤ íŠ¸ë˜ì»¤ (ê¸°ëŠ¥ ì „ì²´ í†µí•© ìµœì¢…ë²„ì „)</h1>
  <div class="search-box">
    <input type="text" id="search-input" placeholder="ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰..." />
    <button onclick="runSearch()">ê²€ìƒ‰</button>
  </div>
  <div class="hot-filter">
    <button data-type="all" class="active" onclick="filterByType('all')">âš« ì „ì²´</button>
    <button data-type="both" onclick="filterByType('both')">ğŸ”´ ë§¤ìš° ì¤‘ìš”</button>
    <button data-type="news" onclick="filterByType('news')">ğŸŸ  ì¤‘ìš”</button>
    <button data-type="channel" onclick="filterByType('channel')">ğŸŸ¡ ë³´í†µ</button>
  </div>
  <div id="sheet-nav" class="sheet-nav"></div>
  <div id="content"><p class="loading">â³ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
  <script>
    let currentData = [];
let searchKeyword = "";

function runSearch() {
  const input = document.getElementById("search-input");
  searchKeyword = input.value.trim();
  if (!currentData.length) return;

  const isAccordion = currentData.some(r => (r["ë‰´ìŠ¤ ì œëª©"] || "").includes("ê´€ë ¨ë‰´ìŠ¤"));
  if (isAccordion) {
    const flatNews = currentData.filter(row => row["ë‰´ìŠ¤ ì œëª©"] && !row["ë‰´ìŠ¤ ì œëª©"].includes("ê´€ë ¨ë‰´ìŠ¤"));
    renderSearchResult(flatNews);
    return;
  }
  const filtered = currentData.filter(row =>
    row["ë‰´ìŠ¤ ì œëª©"]?.includes(searchKeyword)
  );
  renderSearchResult(filtered);
}

function getTimeDiffText(timeStr) {
  const now = new Date();
  const t = new Date(timeStr);
  const diffMs = now - t;
  const diffMin = Math.floor(diffMs / 60000);
  if (diffMin < 1) return "ë°©ê¸ˆ ì „";
  if (diffMin < 60) return `${diffMin}ë¶„ ì „`;
  const hours = Math.floor(diffMin / 60);
  return `${hours}ì‹œê°„ ì „`;
}

function highlightKeyword(text, keyword) {
  if (!keyword) return text;
  const escaped = keyword.replace(/[.*+?^${}()|[\]\]/g, '\$&');
  const reg = new RegExp(`(${escaped})`, "gi");
  return text.replace(reg, '<span class="highlight">$1</span>');
}

function renderSearchResult(data) {
  const content = document.getElementById("content");
  content.innerHTML = "";
  const summary = document.createElement("div");
  summary.className = "news-card";
  if (!data.length) {
    summary.innerHTML = "<p class='loading'>âŒ ì¼ì¹˜í•˜ëŠ” ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  } else {
    const times = data.map(r => new Date(r["ì‹œê°„"])).sort((a, b) => a - b);
    const earliest = times[0];
    const latest = times[times.length - 1];
    const channels = new Set();
    data.forEach(r => r["ì±„ë„ëª…"] && channels.add(r["ì±„ë„ëª…"]));
    summary.innerHTML = `
      <div class="news-title">ğŸ” ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½</div>
      <div class="news-time">ìµœì‹  ë‰´ìŠ¤: ${latest.toLocaleTimeString()} (${getTimeDiffText(latest)})</div>
      <div class="news-time">ìµœì´ˆ ë‰´ìŠ¤: ${earliest.toLocaleTimeString()} (${getTimeDiffText(earliest)})</div>
      <div class="news-time">ì´ ${data.length}ê±´ / ì±„ë„ ${channels.size}ê°œ</div>
    `;
  }
  content.appendChild(summary);

  data.sort((a, b) => new Date(b["ì‹œê°„"]) - new Date(a["ì‹œê°„"]));
  data.forEach(row => {
    const card = document.createElement("div");
    card.className = "news-card";
    card.innerHTML = `
      <div class="news-title">${highlightKeyword(row["ë‰´ìŠ¤ ì œëª©"], searchKeyword)}</div>
      <div class="news-time">ğŸ•’ ${row["ì‹œê°„"]} (${getTimeDiffText(row["ì‹œê°„"] || "")})</div>
      <div class="news-link"><a href="${row["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>
    `;
    content.appendChild(card);
  });
}
  

function loadSheetData() {
  fetch("/sheets")
    .then((res) => res.json())
    .then((sheets) => {
      const nav = document.getElementById("sheet-nav");
      sheets.forEach((sheet, index) => {
        const btn = document.createElement("button");
        btn.textContent = sheet.name;
        btn.onclick = () => loadSheet(sheet.gid);
        btn.classList.add("active");
        nav.appendChild(btn);
        if (index === 0) loadSheet(sheet.gid);
      });
    });
}

function loadSheet(gid) {
  const content = document.getElementById("content");
  content.innerHTML = `<p class='loading'>â³ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>`;

  fetch(`/sheet/${gid}`)
    .then((res) => res.json())
    .then((data) => {
      currentData = calculateImportanceScores(data);
      renderContent(currentData);
    })
    .catch(() => {
      content.innerHTML = `<p class='loading'>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>`;
    });
}

function calculateImportanceScores(data) {
  const scored = data.map((row) => {
    const count = parseInt(row["ê´€ë ¨ë‰´ìŠ¤ ìˆ˜"] || "0");
    const mention = parseInt(row["ì–¸ê¸‰ ì±„ë„ ìˆ˜"] || "0");
    let score = count + mention * 2;
    if (mention >= 5) score += (mention - 4) * 2;
    return { ...row, score };
  });

  scored.sort((a, b) => b.score - a.score);
  const total = scored.length;

  return scored.map((row, index) => {
    const ratio = (index + 1) / total;
    let highlightClass = "";
    if (ratio <= 0.1) highlightClass = "highlight-both";
    else if (ratio <= 0.3) highlightClass = "highlight-news";
    else if (ratio <= 0.6) highlightClass = "highlight-channel";
    return { ...row, highlightClass };
  });
}

function renderContent(data) {
  const content = document.getElementById("content");
  content.innerHTML = "";

  const isAccordion = data.some(r => (r["ë‰´ìŠ¤ ì œëª©"] || "").includes("ê´€ë ¨ë‰´ìŠ¤"));
  if (!isAccordion) {
    data.forEach((row) => {
      const card = document.createElement("div");
      card.className = `news-card ${row.highlightClass}`;
      card.innerHTML = `
        <div class="news-title">${row["ë‰´ìŠ¤ ì œëª©"]}</div>
        <div class="news-time">ğŸ•’ ${row["ì‹œê°„"]} (${getTimeDiffText(row["ì‹œê°„"])})</div>
        <div class="news-time">ğŸ“¡ ê´€ë ¨ë‰´ìŠ¤ ${row["ê´€ë ¨ë‰´ìŠ¤ ìˆ˜"] || 0}ê±´ / ì–¸ê¸‰ì±„ë„ ${row["ì–¸ê¸‰ ì±„ë„ ìˆ˜"] || 0}ê°œ</div>
        <div class="news-link"><a href="${row["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>
      `;
      content.appendChild(card);
    });
  } else {
    let i = 0;
    while (i < data.length) {
      const row = data[i];
      const title = row["ë‰´ìŠ¤ ì œëª©"] || "";
      if (title.includes("ê´€ë ¨ë‰´ìŠ¤")) {
        const acc = document.createElement("button");
        acc.className = `accordion ${row.highlightClass}`;
        const count = parseInt(row["ê´€ë ¨ë‰´ìŠ¤ ìˆ˜"] || "0");
        const mention = parseInt(row["ì–¸ê¸‰ ì±„ë„ ìˆ˜"] || "0");
        acc.textContent = `${title}  â± ${getTimeDiffText(row["ì‹œê°„"])}  |  ğŸ“¡ ${count}ê±´ / ${mention}ì±„ë„`;

        const panel = document.createElement("div");
        panel.className = "panel";

        i++;
        while (i < data.length && (data[i]["ë‰´ìŠ¤ ì œëª©"] || "").trim() !== "") {
          const news = data[i];
          const item = document.createElement("div");
          item.className = "news-card";
          item.innerHTML = `
            <div class="news-title">${news["ë‰´ìŠ¤ ì œëª©"]}</div>
            <div class="news-time">ğŸ•’ ${news["ì‹œê°„"]}</div>
            <div class="news-link"><a href="${news["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
          panel.appendChild(item);
          i++;
        }

        acc.onclick = () => {
          acc.classList.toggle("active");
          panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
        };
        content.appendChild(acc);
        content.appendChild(panel);
      } else {
        i++;
      }
    }
  }
}`;
    card.innerHTML = `
      <div class="news-title">${row["ë‰´ìŠ¤ ì œëª©"]}</div>
      <div class="news-time">ğŸ•’ ${row["ì‹œê°„"]} (${getTimeDiffText(row["ì‹œê°„"])})</div>
      <div class="news-time">ğŸ“¡ ê´€ë ¨ë‰´ìŠ¤ ${row["ê´€ë ¨ë‰´ìŠ¤ ìˆ˜"] || 0}ê±´ / ì–¸ê¸‰ì±„ë„ ${row["ì–¸ê¸‰ ì±„ë„ ìˆ˜"] || 0}ê°œ</div>
      <div class="news-link"><a href="${row["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>
    `;
    content.appendChild(card);
  });
}

loadSheetData();

// ìë™ ìƒˆë¡œê³ ì¹¨ (60ì´ˆë§ˆë‹¤ í˜„ì¬ ì‹œíŠ¸ ë‹¤ì‹œ ë¡œë“œ)
setInterval(() => {
  const active = document.querySelector(".sheet-nav button.active");
  if (active) {
    active.click();
    document.getElementById('search-input').value = searchKeyword;
    if (searchKeyword) runSearch();
    if (activeFilter) filterByType(activeFilter);
  }
}, 60000);
</script>
</body>
</html>
