<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë””ë§ˆë‹ˆì½” ë‰´ìŠ¤ íŠ¸ë˜ì»¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Arial', sans-serif; background: #f4f6f9; margin: 0; padding: 16px; }
    h1 { text-align: center; color: #222; }
    .sheet-nav { position: sticky; top: 0; background: #fff; padding: 10px 0; border-bottom: 1px solid #ddd; z-index: 999; overflow-x: auto; white-space: nowrap; }
    .sheet-nav button { margin: 0 6px; padding: 8px 12px; border-radius: 16px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; font-size: 0.95em; display: inline-block; }
    .sheet-nav button.active { background: #007bff; color: white; border-color: #007bff; }

    .sheet-title { font-size: 1.2em; font-weight: bold; margin: 20px 0 10px; color: #007bff; }
    .news-card { background: #fff; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: 0.3s; }
    .highlight-news { background: #fff7e6; }
    .highlight-channel { background: #ffe6cc; }
    .highlight-both { background: #ffe5e5; border: 2px solid #cc0000; }

    .accordion { background: #fff; font-weight: bold; cursor: pointer; padding: 14px 16px; width: 100%; border: none; text-align: left; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 8px; transition: 0.3s; }
    .accordion:hover, .accordion.active { background-color: #e4f0ff; }
    .panel { padding: 0 16px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-left: 3px solid #007bff; border-radius: 0 0 8px 8px; }

    .news-title { font-weight: bold; font-size: 1.1em; color: #222; }
    .news-time { font-size: 0.9em; color: #666; margin-top: 6px; }
    .news-link a { font-size: 0.9em; color: #007bff; text-decoration: none; }
    .loading { color: #888; font-size: 0.95em; padding: 12px; text-align: center; }
  </style>
</head>
<body>
<h1>ë””ë§ˆë‹ˆì½” ë‰´ìŠ¤ íŠ¸ë˜ì»¤</h1>
<div id="sheet-nav" class="sheet-nav"></div>
<div id="content"><p class="loading">â³ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>

<script>
let currentBtn = null;

function renderAccordion(data, container) {
  let i = 0;
  while (i < data.length) {
    const row = data[i];
    const title = row["ë‰´ìŠ¤ ì œëª©"] || "";
    if (title.includes("ê´€ë ¨ë‰´ìŠ¤")) {
      const groupTitle = title;
      const acc = document.createElement("button");
      acc.className = "accordion";
      acc.textContent = `ğŸ“£ ${groupTitle}`;
      const panel = document.createElement("div");
      panel.className = "panel";
      i++;
      while (i < data.length && (data[i]["ë‰´ìŠ¤ ì œëª©"] || "").trim() !== "") {
        const news = data[i];
        const item = document.createElement("div");
        item.className = "news-card";
        item.innerHTML = `
          <div class="news-title">${news["ë‰´ìŠ¤ ì œëª©"]}</div>
          <div class="news-time">ğŸ•’ ${news["ì‹œê°„"]}</div>
          <div class="news-link"><a href="${news["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
        panel.appendChild(item);
        i++;
      }
      acc.onclick = () => {
        acc.classList.toggle("active");
        panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
      };
      container.appendChild(acc);
      container.appendChild(panel);
    } else {
      i++;
    }
  }
}

function renderHotCard(row, container) {
  const count = parseInt(row["ê´€ë ¨ë‰´ìŠ¤ ìˆ˜"] || "0");
  const mention = parseInt(row["ì–¸ê¸‰ ì±„ë„ ìˆ˜"] || "0");
  let highlightClass = "";
  if (count >= 10 && mention >= 3) highlightClass = "highlight-both";
  else if (count >= 10) highlightClass = "highlight-news";
  else if (mention >= 3) highlightClass = "highlight-channel";

  const card = document.createElement("div");
  card.className = `news-card ${highlightClass}`;
  card.innerHTML = `
    <div class="news-title">${row["ëŒ€í‘œ ë‰´ìŠ¤ ì œëª©"]}</div>
    <div class="news-time">ğŸ•’ ìµœì‹ : ${row["ìµœì‹  ë‰´ìŠ¤ ì‹œê°„"]} / ìµœì´ˆ: ${row["ìµœì´ˆ ë‰´ìŠ¤ ì‹œê°„"]}</div>
    <div class="news-time">ğŸ“¡ ê´€ë ¨ë‰´ìŠ¤ ${count}ê±´ / ì–¸ê¸‰ì±„ë„ ${mention}ê°œ</div>
    <div class="news-link"><a href="${row["ìµœì‹  ë‰´ìŠ¤ ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
  container.appendChild(card);
}

function renderFlatNews(row, container) {
  const item = document.createElement("div");
  item.className = "news-card";
  item.innerHTML = `
    <div class="news-title">${row["ë‰´ìŠ¤ ì œëª©"]}</div>
    <div class="news-time">ğŸ•’ ${row["ì‹œê°„"]}</div>
    <div class="news-link"><a href="${row["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
  container.appendChild(item);
}

function extractDate(sheetName) {
  const match = sheetName.match(/\d{2}\.\d{2}/); // e.g. 04.17
  if (match) {
    return new Date(`20${match[0].replace('.', '-')}`);
  }
  return new Date(0); // ì˜¤ë˜ëœ ë‚ ì§œ ê¸°ë³¸ê°’
}

function getPriority(name) {
  if (name.includes("HOT")) return 0;
  if (name.includes("ì´ìŠˆ")) return 1;
  if (name.includes("ì±„ë„")) return 2;
  if (name.includes("DB")) return 3;
  return 4;
}

function loadSheet(gid, name, btn) {
  if (currentBtn) currentBtn.classList.remove("active");
  currentBtn = btn;
  btn.classList.add("active");
  document.getElementById("content").innerHTML = "<p class='loading'>â³ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";
  fetch(`/sheet/${gid}`).then(res => res.json()).then(data => {
    const container = document.createElement("div");
    container.innerHTML = `<div class="sheet-title">ğŸ“Œ ${name}</div>`;
    const content = document.getElementById("content");
    content.innerHTML = "";

    const isAccordion = data.some(r => (r["ë‰´ìŠ¤ ì œëª©"] || "").includes("ê´€ë ¨ë‰´ìŠ¤"));
    const isHot = name.includes("HOT");

    if (isAccordion) {
      renderAccordion(data, container);
    } else if (isHot) {
      data.forEach(row => {
        if (row["ëŒ€í‘œ ë‰´ìŠ¤ ì œëª©"] && row["ìµœì‹  ë‰´ìŠ¤ ë§í¬"]) renderHotCard(row, container);
      });
    } else {
      data.forEach(row => {
        if (row["ë‰´ìŠ¤ ì œëª©"] && row["ë§í¬"]) renderFlatNews(row, container);
      });
    }
    content.appendChild(container);
  });
}

fetch("/sheets").then(res => res.json()).then(sheets => {
  // ë‚ ì§œ ìµœì‹ ìˆœ + HOT > ì´ìŠˆ > ì±„ë„ > DB ì •ë ¬
  sheets.sort((a, b) => {
    const d1 = extractDate(a.name);
    const d2 = extractDate(b.name);
    if (d1.getTime() !== d2.getTime()) return d2 - d1;
    return getPriority(a.name) - getPriority(b.name);
  });

  const nav = document.getElementById("sheet-nav");
  sheets.forEach((sheet, i) => {
    const btn = document.createElement("button");
    btn.textContent = sheet.name;
    btn.onclick = () => loadSheet(sheet.gid, sheet.name, btn);
    nav.appendChild(btn);
    if (i === 0) loadSheet(sheet.gid, sheet.name, btn);
  });
});
</script>
</body>
</html>
