<!DOCTYPE html>
<html lang="ko">
 <head>
  <meta charset="utf-8"/>
  <title>
   ë””ë§ˆë‹ˆì½” ë‰´ìŠ¤ íŠ¸ë˜ì»¤
  </title>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <style>
   body { font-family: 'Arial', sans-serif; background: #f4f6f9; margin: 0; padding: 16px; }
    h1 { text-align: center; color: #222; }
    .sheet-nav { position: sticky; top: 0; background: #fff; padding: 10px 0; border-bottom: 1px solid #ddd; z-index: 999; overflow-x: auto; white-space: nowrap; }
    .sheet-nav button { margin: 0 6px; padding: 8px 12px; border-radius: 16px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; font-size: 0.95em; display: inline-block; }
    .sheet-nav button.active { background: #007bff; color: white; border-color: #007bff; }

    .sheet-title { font-size: 1.2em; font-weight: bold; margin: 20px 0 10px; color: #007bff; }
    .hot-filter { margin-bottom: 12px; text-align: center; }
    .hot-filter button { margin: 0 6px; padding: 6px 14px; border-radius: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease; }
    .hot-filter button.active { background: #007bff; color: #fff; border-color: #007bff; }

    .news-card { background: #fff; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: opacity 0.3s ease; opacity: 1; }
    .news-card.hide { display: none; opacity: 0; }

    .highlight-news { background: #fff7e6; }
    .highlight-channel { background: #ffe6cc; }
    .highlight-both { background: #ffe5e5; border: 2px solid #cc0000; }

    .accordion { font-size: 1.15em; font-weight: bold; cursor: pointer; padding: 16px 18px; width: 100%; border: none; text-align: left; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 8px; transition: 0.3s; }
    .accordion:hover, .accordion.active { background-color: #e4f0ff; }
    .panel { padding: 0 16px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-left: 3px solid #007bff; border-radius: 0 0 8px 8px; }

    .news-title { font-weight: bold; font-size: 1.1em; color: #222; }
    .news-time { font-size: 0.9em; color: #666; margin-top: 6px; }
    .news-link a { font-size: 0.9em; color: #007bff; text-decoration: none; }
    .loading { color: #888; font-size: 0.95em; padding: 12px; text-align: center; }

    .fade-container { opacity: 1; transition: opacity 0.3s ease; }
    .fade-container.fade-out { opacity: 0; }
  
<style>
  .hot-filter {
    margin: 12px 0;
    text-align: center;
    white-space: nowrap;
    overflow-x: auto;
  }
  .hot-filter button {
    margin: 0 6px;
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid #ccc;
    background: #fff;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s ease;
  }
  .hot-filter button.active {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
  }

  .news-title {
    font-weight: bold;
    font-size: 1.1em;
    color: #111 !important;
  }

  .news-time {
    font-size: 0.9em;
    color: #666;
    margin-top: 6px;
  }

  .search-box {
    text-align: center;
    margin-bottom: 16px;
  }
  .search-box input {
    padding: 8px 12px;
    font-size: 1em;
    width: 70%;
    max-width: 300px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  .search-box button {
    padding: 8px 14px;
    margin-left: 6px;
    font-size: 1em;
    border-radius: 8px;
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  .highlight {
    background-color: #fff176;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 4px;
  }

  .highlight-both {
    background: #ffe5e5;
    border: 2px solid #cc0000;
  }
  .highlight-news {
    background: #fff7e6;
  }
  .highlight-channel {
    background: #ffe6cc;
  }

<style>
  .hot-filter {
    margin: 12px 0;
    text-align: center;
    white-space: nowrap;
    overflow-x: auto;
  }
  .hot-filter button {
    margin: 0 6px;
    padding: 6px 12px;
    border-radius: 20px;
    border: 1px solid #ccc;
    background: #fff;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s ease;
  }
  .hot-filter button.active {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
  }

  .news-title {
    font-weight: bold;
    font-size: 1.1em;
    color: #111 !important;
  }

  .news-time {
    font-size: 0.9em;
    color: #666;
    margin-top: 6px;
  }

  .search-box {
    text-align: center;
    margin-bottom: 16px;
  }
  .search-box input {
    padding: 8px 12px;
    font-size: 1em;
    width: 70%;
    max-width: 300px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }
  .search-box button {
    padding: 8px 14px;
    margin-left: 6px;
    font-size: 1em;
    border-radius: 8px;
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }

  .highlight {
    background-color: #fff176;
    font-weight: bold;
    padding: 0 2px;
    border-radius: 4px;
  }

  .highlight-both {
    background: #ffe5e5;
    border: 2px solid #cc0000;
  }
  .highlight-news {
    background: #fff7e6;
  }
  .highlight-channel {
    background: #ffe6cc;
  }
  </style>
 </head>
 <body>
  <h1>
   ë””ë§ˆë‹ˆì½” ë‰´ìŠ¤ íŠ¸ë˜ì»¤
  </h1>
  <div class="sheet-nav" id="sheet-nav">
  </div>
  <div id="content">
   <p class="loading">
    â³ ë‰´ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
   </p>
  </div>
  <script>
   let currentBtn = null;
let currentData = [];
let activeFilter = null;

function renderAccordion(data, container) {
  let i = 0;
  while (i < data.length) {
    const row = data[i];
    const title = row["ë‰´ìŠ¤ ì œëª©"] || "";
    if (title.includes("ê´€ë ¨ë‰´ìŠ¤")) {
      const groupTitle = title;
      const acc = document.createElement("button");
      acc.className = "accordion";
      acc.textContent = `ğŸ“£ ${groupTitle}`;
      const panel = document.createElement("div");
      panel.className = "panel";
      i++;
      while (i < data.length && (data[i]["ë‰´ìŠ¤ ì œëª©"] || "").trim() !== "") {
        const news = data[i];
        const item = document.createElement("div");
        item.className = "news-card";
        item.innerHTML = `
          <div class="news-title">${news["ë‰´ìŠ¤ ì œëª©"]}</div>
          <div class="news-time">ğŸ•’ ${news["ì‹œê°„"]}</div>
          <div class="news-link"><a href="${news["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
        panel.appendChild(item);
        i++;
      }
      acc.onclick = () => {
        acc.classList.toggle("active");
        panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
      };
      container.appendChild(acc);
      container.appendChild(panel);
    } else {
      i++;
    }
  }
}

function renderHotFilter(container) {
  const filterBox = document.createElement("div");
  filterBox.className = "hot-filter";
  filterBox.innerHTML = `
    <button data-type="all" class="active">âš« ì „ì²´</button>
    <button data-type="both">ğŸ”´ ë² ìŠ¤íŠ¸</button>
    <button data-type="news">ğŸŸ  í™•ì‚°ì¤‘</button>
    <button data-type="channel">ğŸŸ¡ ë‰´ìŠ¤í”½</button>
  `;

  const buttons = filterBox.querySelectorAll("button");
  const allBtn = filterBox.querySelector('[data-type="all"]');

  buttons.forEach(btn => {
    btn.onclick = () => {
      const type = btn.getAttribute("data-type");
      if (type === "all") {
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        activeFilter = null;
        document.querySelectorAll(".news-card").forEach(c => c.style.display = "block");
        return;
      }
      if (activeFilter === type) {
        activeFilter = null;
        btn.classList.remove("active");
        allBtn.classList.add("active");
        document.querySelectorAll(".news-card").forEach(c => c.style.display = "block");
        return;
      }
      activeFilter = type;
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".news-card").forEach(card => {
        card.style.display = "none";
        if (type === "both" && card.classList.contains("highlight-both")) card.style.display = "block";
        else if (type === "news" && card.classList.contains("highlight-news")) card.style.display = "block";
        else if (type === "channel" && card.classList.contains("highlight-channel")) card.style.display = "block";
      });
    };
  });
  container.appendChild(filterBox);
}

function renderHotCard(row, container) {
  const count = parseInt(row["ê´€ë ¨ë‰´ìŠ¤ ìˆ˜"] || "0");
  const mention = parseInt(row["ì–¸ê¸‰ ì±„ë„ ìˆ˜"] || "0");
  let highlightClass = "";
  if (count >= 10 && mention >= 3) highlightClass = "highlight-both";
  else if (count >= 10) highlightClass = "highlight-news";
  else if (mention >= 3) highlightClass = "highlight-channel";

  const card = document.createElement("div");
  card.className = `news-card ${highlightClass}`;
  card.innerHTML = `
    <div class="news-title">${row["ëŒ€í‘œ ë‰´ìŠ¤ ì œëª©"]}</div>
    <div class="news-time">ğŸ•’ ìµœì‹ : ${row["ìµœì‹  ë‰´ìŠ¤ ì‹œê°„"]} / ìµœì´ˆ: ${row["ìµœì´ˆ ë‰´ìŠ¤ ì‹œê°„"]}</div>
    <div class="news-time">ğŸ“¡ ê´€ë ¨ë‰´ìŠ¤ ${count}ê±´ / ì–¸ê¸‰ì±„ë„ ${mention}ê°œ</div>
    <div class="news-link"><a href="${row["ìµœì‹  ë‰´ìŠ¤ ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
  container.appendChild(card);
}

function renderFlatNews(row, container) {
  const item = document.createElement("div");
  item.className = "news-card";
  item.innerHTML = `
    <div class="news-title">${row["ë‰´ìŠ¤ ì œëª©"]}</div>
    <div class="news-time">ğŸ•’ ${row["ì‹œê°„"]}</div>
    <div class="news-link"><a href="${row["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>`;
  container.appendChild(item);
}

function renderContent(data, container, sheetName) {
  container.className = "fade-container";
  container.innerHTML = `<div class="sheet-title">ğŸ“Œ ${sheetName}</div>`;
  const isAccordion = data.some(r => (r["ë‰´ìŠ¤ ì œëª©"] || "").includes("ê´€ë ¨ë‰´ìŠ¤"));
  const isHot = sheetName.includes("HOT");

  if (isAccordion) {
    renderAccordion(data, container);
  } else if (isHot) {
    renderHotFilter(container);
    data.forEach(row => {
      if (row["ëŒ€í‘œ ë‰´ìŠ¤ ì œëª©"] && row["ìµœì‹  ë‰´ìŠ¤ ë§í¬"]) renderHotCard(row, container);
    });
  } else {
    data.forEach(row => {
      if (row["ë‰´ìŠ¤ ì œëª©"] && row["ë§í¬"]) renderFlatNews(row, container);
    });
  }
}

function extractDate(sheetName) {
  const match = sheetName.match(/\d{2}\.\d{2}/);
  if (match) {
    const today = new Date();
    const year = today.getFullYear();
    return new Date(`${year}-${match[0].replace('.', '-')}`);
  }
  return new Date(0);
}

function getPriority(name) {
  if (name.includes("HOT")) return 0;
  if (name.includes("ì´ìŠˆ")) return 1;
  if (name.includes("ì±„ë„")) return 2;
  if (name.includes("DB")) return 3;
  return 4;
}

function loadSheet(gid, name, btn, isRefresh = false) {
  if (!isRefresh) {
    if (currentBtn) currentBtn.classList.remove("active");
    currentBtn = btn;
    btn.classList.add("active");
  }

  const content = document.getElementById("content");
  content.classList.add("fade-out");

  fetch(`/sheet/${gid}`).then(res => res.json()).then(data => {
    const newTitles = data.map(r => r["ë‰´ìŠ¤ ì œëª©"]).join("|");
    const oldTitles = currentData.map(r => r["ë‰´ìŠ¤ ì œëª©"]).join("|");
    if (newTitles === oldTitles && isRefresh) {
      content.classList.remove("fade-out");
      return;
    }

    currentData = data;
    const container = document.createElement("div");
    renderContent(data, container, name);

    setTimeout(() => {
      content.innerHTML = "";
      content.appendChild(container);
      content.classList.remove("fade-out");
    }, 300);
  });
}

fetch("/sheets").then(res => res.json()).then(sheets => {
  sheets.sort((a, b) => {
    const d1 = extractDate(a.name);
    const d2 = extractDate(b.name);
    if (d1.getTime() !== d2.getTime()) return d2 - d1;
    return getPriority(a.name) - getPriority(b.name);
  });

  const nav = document.getElementById("sheet-nav");
  sheets.forEach((sheet, i) => {
    const btn = document.createElement("button");
    btn.textContent = sheet.name;
    btn.dataset.gid = sheet.gid;
    btn.onclick = () => loadSheet(sheet.gid, sheet.name, btn);
    nav.appendChild(btn);
    if (i === 0) loadSheet(sheet.gid, sheet.name, btn);
  });

  setInterval(() => {
    if (currentBtn) {
      const gid = currentBtn.dataset.gid;
      const name = currentBtn.textContent;
      loadSheet(gid, name, currentBtn, true);
    }
  }, 60000);
});
  </script>
  <script>
   let searchKeyword = "";
let activeFilter = null;

function highlightKeyword(text, keyword) {
  if (!keyword) return text;
  const regex = new RegExp(\`(\${keyword})\`, 'gi');
  return text.replace(regex, '<span class="highlight">$1</span>');
}

function getTimeDiffText(timeStr) {
  const now = new Date();
  const time = new Date(timeStr);
  const diff = Math.floor((now - time) / 60000); // ë¶„ ë‹¨ìœ„
  if (isNaN(diff)) return "";
  if (diff < 1) return "ë°©ê¸ˆ ì „";
  if (diff < 60) return \`\${diff}ë¶„ ì „\`;
  const h = Math.floor(diff / 60);
  if (h < 24) return \`\${h}ì‹œê°„ ì „\`;
  const d = Math.floor(h / 24);
  return \`\${d}ì¼ ì „\`;
}

function runSearch() {
  const input = document.getElementById("search-input");
  searchKeyword = input.value.trim();
  if (!searchKeyword) {
    location.reload();
    return;
  }
  const filtered = currentData.filter(r =>
    r["ë‰´ìŠ¤ ì œëª©"] && r["ë‰´ìŠ¤ ì œëª©"].toLowerCase().includes(searchKeyword.toLowerCase())
  );
  renderSearchResult(filtered);
}

function renderSearchSummary(data) {
  const summary = document.createElement("div");
  summary.className = "news-card";
  if (!data.length) {
    summary.innerHTML = "<p class='loading'>âŒ ì¼ì¹˜í•˜ëŠ” ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
  } else {
    const times = data.map(r => new Date(r["ì‹œê°„"])).sort((a, b) => a - b);
    const earliest = times[0];
    const latest = times[times.length - 1];
    const channels = new Set();
    data.forEach(r => r["ì±„ë„ëª…"] && channels.add(r["ì±„ë„ëª…"]));
    summary.innerHTML = \`
      <div class="news-title">ğŸ” ê²€ìƒ‰ ê²°ê³¼ ìš”ì•½</div>
      <div class="news-time">ìµœì‹  ë‰´ìŠ¤: \${latest.toLocaleTimeString()} (\${getTimeDiffText(latest)})</div>
      <div class="news-time">ìµœì´ˆ ë‰´ìŠ¤: \${earliest.toLocaleTimeString()} (\${getTimeDiffText(earliest)})</div>
      <div class="news-time">ì´ \${data.length}ê±´ / ì±„ë„ \${channels.size}ê°œ</div>
    \`;
  }
  return summary;
}

function renderSearchResult(data) {
  const content = document.getElementById("content");
  content.innerHTML = "";
  const summary = renderSearchSummary(data);
  content.appendChild(summary);
  data.sort((a, b) => new Date(b["ì‹œê°„"]) - new Date(a["ì‹œê°„"]));
  data.forEach(row => {
    const card = document.createElement("div");
    card.className = "news-card";
    card.innerHTML = \`
      <div class="news-title">\${highlightKeyword(row["ë‰´ìŠ¤ ì œëª©"], searchKeyword)}</div>
      <div class="news-time">ğŸ•’ \${row["ì‹œê°„"]} (\${getTimeDiffText(row["ì‹œê°„"] || "")})</div>
      <div class="news-link"><a href="\${row["ë§í¬"]}" target="_blank">ğŸ‘‰ ë‰´ìŠ¤ ë³´ëŸ¬ê°€ê¸°</a></div>
    \`;
    content.appendChild(card);
  });
}

function showErrorMessage() {
  const content = document.getElementById("content");
  content.innerHTML = "<p class='loading'>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>";
}

function renderSkeletons(container, count = 5) {
  container.innerHTML = "";
  for (let i = 0; i < count; i++) {
    const card = document.createElement("div");
    card.className = "news-card";
    card.style.opacity = "0.3";
    card.innerHTML = \`
      <div class="news-title">â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’â–’</div>
      <div class="news-time">ğŸ•’ â–’â–’â–’â–’â–’â–’â–’â–’â–’</div>
      <div class="news-link"><a>â–’â–’â–’â–’â–’â–’â–’â–’â–’</a></div>\`;
    container.appendChild(card);
  }
}

function filterByType(type) {
  activeFilter = type === "all" ? null : type;
  document.querySelectorAll(".hot-filter button").forEach(btn => btn.classList.remove("active"));
  const activeBtn = document.querySelector(\`.hot-filter button[data-type='\${type}']\`);
  if (activeBtn) activeBtn.classList.add("active");

  document.querySelectorAll(".news-card, .accordion").forEach(card => {
    const show = !activeFilter || card.classList.contains(\`highlight-\${activeFilter}\`);
    card.style.display = show ? "block" : "none";
    const panel = card.nextElementSibling;
    if (panel && panel.classList.contains("panel")) {
      panel.style.display = show ? "block" : "none";
    }
  });
}

setInterval(() => {
  const active = document.querySelector(".sheet-nav button.active");
  if (active) {
    active.click();
    document.getElementById("search-input").value = searchKeyword;
    if (searchKeyword) runSearch();
    if (activeFilter) filterByType(activeFilter);
  }
}, 60000);
  </script>
  <script>
   function updateAccordionTitles() {
  const accordions = document.querySelectorAll(".accordion");
  accordions.forEach(acc => {
    const panel = acc.nextElementSibling;
    if (!panel) return;

    const cards = panel.querySelectorAll(".news-card");
    let earliest = null, latest = null;
    const channels = new Set();

    cards.forEach(card => {
      const timeText = card.querySelector(".news-time")?.textContent || "";
      const match = timeText.match(/\d{2}:\d{2}:\d{2}/);
      if (match) {
        const time = new Date("1970-01-01T" + match[0]);
        if (!earliest || time < earliest) earliest = time;
        if (!latest || time > latest) latest = time;
      }

      const title = card.querySelector(".news-title")?.textContent || "";
      const ch = title.split("]")[0].replace("[", "").trim();
      if (ch) channels.add(ch);
    });

    const timeDiff = latest && earliest ? Math.round((latest - earliest) / 60000) : 0;
    const min = timeDiff % 60;
    const h = Math.floor(timeDiff / 60);
    const diffText = timeDiff === 0 ? "ë™ì‹œ" : h ? `${h}ì‹œê°„ ${min}ë¶„ì°¨` : `${min}ë¶„ì°¨`;

    acc.textContent = `ğŸ“£ ê´€ë ¨ë‰´ìŠ¤ ${cards.length}ê±´ / ì±„ë„ ${channels.size}ê°œ / ${diffText}`;
  });
}

window.addEventListener("load", () => {
  updateAccordionTitles();
});
  </script>
 </body>
</html>
