<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>디마니코 뉴스 트래커</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Arial', sans-serif; background: #f4f6f9; margin: 0; padding: 16px; }
    h1 { text-align: center; color: #222; }
    .sheet-nav { position: sticky; top: 0; background: #fff; padding: 10px 0; border-bottom: 1px solid #ddd; z-index: 999; overflow-x: auto; white-space: nowrap; }
    .sheet-nav button { margin: 0 6px; padding: 8px 12px; border-radius: 16px; border: 1px solid #ccc; background: #f9f9f9; cursor: pointer; font-size: 0.95em; display: inline-block; }
    .sheet-nav button.active { background: #007bff; color: white; border-color: #007bff; }

    .sheet-title { font-size: 1.2em; font-weight: bold; margin: 20px 0 10px; color: #007bff; }
    .hot-filter { margin-bottom: 12px; text-align: center; }
    .hot-filter button { margin: 0 6px; padding: 6px 14px; border-radius: 20px; border: 1px solid #ccc; background: #fff; cursor: pointer; font-size: 0.9em; transition: all 0.2s ease; }
    .hot-filter button.active { background: #007bff; color: #fff; border-color: #007bff; }

    .news-card { background: #fff; padding: 16px; margin-bottom: 12px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: opacity 0.3s ease; opacity: 1; }
    .news-card.hide { display: none; opacity: 0; }

    .highlight-news { background: #fff7e6; }
    .highlight-channel { background: #ffe6cc; }
    .highlight-both { background: #ffe5e5; border: 2px solid #cc0000; }

    .accordion { font-size: 1.15em; font-weight: bold; cursor: pointer; padding: 16px 18px; width: 100%; border: none; text-align: left; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 8px; transition: 0.3s; }
    .accordion:hover, .accordion.active { background-color: #e4f0ff; }
    .panel { padding: 0 16px; background-color: white; max-height: 0; overflow: hidden; transition: max-height 0.2s ease-out; border-left: 3px solid #007bff; border-radius: 0 0 8px 8px; }

    .news-title { font-weight: bold; font-size: 1.1em; color: #222; }
    .news-time { font-size: 0.9em; color: #666; margin-top: 6px; }
    .news-link a { font-size: 0.9em; color: #007bff; text-decoration: none; }
    .loading { color: #888; font-size: 0.95em; padding: 12px; text-align: center; }
  </style>
</head>
<body>
<h1>디마니코 뉴스 트래커</h1>
<div id="sheet-nav" class="sheet-nav"></div>
<div id="content"><p class="loading">⏳ 뉴스 데이터를 불러오는 중입니다...</p></div>

<script>
let currentBtn = null;
let activeFilter = null;

function renderAccordion(data, container) {
  let i = 0;
  while (i < data.length) {
    const row = data[i];
    const title = row["뉴스 제목"] || "";
    if (title.includes("관련뉴스")) {
      const groupTitle = title;
      const acc = document.createElement("button");
      acc.className = "accordion";
      acc.textContent = `📣 ${groupTitle}`;
      const panel = document.createElement("div");
      panel.className = "panel";
      i++;
      while (i < data.length && (data[i]["뉴스 제목"] || "").trim() !== "") {
        const news = data[i];
        const item = document.createElement("div");
        item.className = "news-card";
        item.innerHTML = `
          <div class="news-title">${news["뉴스 제목"]}</div>
          <div class="news-time">🕒 ${news["시간"]}</div>
          <div class="news-link"><a href="${news["링크"]}" target="_blank">👉 뉴스 보러가기</a></div>`;
        panel.appendChild(item);
        i++;
      }
      acc.onclick = () => {
        acc.classList.toggle("active");
        panel.style.maxHeight = panel.style.maxHeight ? null : panel.scrollHeight + "px";
      };
      container.appendChild(acc);
      container.appendChild(panel);
    } else {
      i++;
    }
  }
}

function renderHotFilter(container) {
  const filterBox = document.createElement("div");
  filterBox.className = "hot-filter";
  filterBox.innerHTML = `
    <button data-type="all" class="active">⚫ 전체</button>
    <button data-type="both">🔴 베스트</button>
    <button data-type="news">🟠 확산중</button>
    <button data-type="channel">🟡 뉴스픽</button>
  `;

  const buttons = filterBox.querySelectorAll("button");
  const allBtn = filterBox.querySelector('[data-type="all"]');

  buttons.forEach(btn => {
    btn.onclick = () => {
      const type = btn.getAttribute("data-type");
      if (type === "all") {
        buttons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        activeFilter = null;
        document.querySelectorAll(".news-card").forEach(c => c.style.display = "block");
        return;
      }
      if (activeFilter === type) {
        activeFilter = null;
        btn.classList.remove("active");
        allBtn.classList.add("active");
        document.querySelectorAll(".news-card").forEach(c => c.style.display = "block");
        return;
      }
      activeFilter = type;
      buttons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      document.querySelectorAll(".news-card").forEach(card => {
        card.style.display = "none";
        if (type === "both" && card.classList.contains("highlight-both")) card.style.display = "block";
        else if (type === "news" && card.classList.contains("highlight-news")) card.style.display = "block";
        else if (type === "channel" && card.classList.contains("highlight-channel")) card.style.display = "block";
      });
    };
  });
  container.appendChild(filterBox);
}

function renderHotCard(row, container) {
  const count = parseInt(row["관련뉴스 수"] || "0");
  const mention = parseInt(row["언급 채널 수"] || "0");
  let highlightClass = "";
  if (count >= 10 && mention >= 3) highlightClass = "highlight-both";
  else if (count >= 10) highlightClass = "highlight-news";
  else if (mention >= 3) highlightClass = "highlight-channel";

  const card = document.createElement("div");
  card.className = `news-card ${highlightClass}`;
  card.innerHTML = `
    <div class="news-title">${row["대표 뉴스 제목"]}</div>
    <div class="news-time">🕒 최신: ${row["최신 뉴스 시간"]} / 최초: ${row["최초 뉴스 시간"]}</div>
    <div class="news-time">📡 관련뉴스 ${count}건 / 언급채널 ${mention}개</div>
    <div class="news-link"><a href="${row["최신 뉴스 링크"]}" target="_blank">👉 뉴스 보러가기</a></div>`;
  container.appendChild(card);
}

function renderFlatNews(row, container) {
  const item = document.createElement("div");
  item.className = "news-card";
  item.innerHTML = `
    <div class="news-title">${row["뉴스 제목"]}</div>
    <div class="news-time">🕒 ${row["시간"]}</div>
    <div class="news-link"><a href="${row["링크"]}" target="_blank">👉 뉴스 보러가기</a></div>`;
  container.appendChild(item);
}

function extractDate(sheetName) {
  const match = sheetName.match(/\d{2}\.\d{2}/);
  if (match) {
    const today = new Date();
    const year = today.getFullYear();
    return new Date(`${year}-${match[0].replace('.', '-')}`);
  }
  return new Date(0);
}

function getPriority(name) {
  if (name.includes("HOT")) return 0;
  if (name.includes("이슈")) return 1;
  if (name.includes("채널")) return 2;
  if (name.includes("DB")) return 3;
  return 4;
}

function loadSheet(gid, name, btn) {
  if (currentBtn) currentBtn.classList.remove("active");
  currentBtn = btn;
  btn.classList.add("active");
  document.getElementById("content").innerHTML = "<p class='loading'>⏳ 뉴스 데이터를 불러오는 중입니다...</p>";
  fetch(`/sheet/${gid}`).then(res => res.json()).then(data => {
    const container = document.createElement("div");
    container.innerHTML = `<div class="sheet-title">📌 ${name}</div>`;
    const content = document.getElementById("content");
    content.innerHTML = "";

    const isAccordion = data.some(r => (r["뉴스 제목"] || "").includes("관련뉴스"));
    const isHot = name.includes("HOT");

    if (isAccordion) {
      renderAccordion(data, container);
    } else if (isHot) {
      renderHotFilter(container);
      data.forEach(row => {
        if (row["대표 뉴스 제목"] && row["최신 뉴스 링크"]) renderHotCard(row, container);
      });
    } else {
      data.forEach(row => {
        if (row["뉴스 제목"] && row["링크"]) renderFlatNews(row, container);
      });
    }
    content.appendChild(container);
  });
}

fetch("/sheets").then(res => res.json()).then(sheets => {
  sheets.sort((a, b) => {
    const d1 = extractDate(a.name);
    const d2 = extractDate(b.name);
    if (d1.getTime() !== d2.getTime()) return d2 - d1;
    return getPriority(a.name) - getPriority(b.name);
  });

  const nav = document.getElementById("sheet-nav");
  sheets.forEach((sheet, i) => {
    const btn = document.createElement("button");
    btn.textContent = sheet.name;
    btn.onclick = () => loadSheet(sheet.gid, sheet.name, btn);
    nav.appendChild(btn);
    if (i === 0) loadSheet(sheet.gid, sheet.name, btn);
  });
});
</script>
</body>
</html>
